# 架构设计文档

## 系统架构

```
┌─────────────────────────────────────────┐
│         微信小程序前端                    │
│  ┌──────┬──────┬──────┬────────────┐   │
│  │农户端│工人端│工头端│  介绍方端   │   │
│  └──────┴──────┴──────┴────────────┘   │
└─────────────────────────────────────────┘
                  │
                  │ HTTP/WebSocket
                  ▼
┌─────────────────────────────────────────┐
│         微信云开发平台                    │
│  ┌──────────────────────────────────┐   │
│  │         云函数层                  │   │
│  │  ┌──────┬──────┬──────┬────────┐ │   │
│  │  │订单  │支付 │结算 │通知 │ │   │
│  │  └──────┴──────┴──────┴────────┘ │   │
│  └──────────────────────────────────┘   │
│  ┌──────────────────────────────────┐   │
│  │         云数据库                    │   │
│  │  users, orders, payments, etc.   │   │
│  └──────────────────────────────────┘   │
│  ┌──────────────────────────────────┐   │
│  │         云存储                     │   │
│  │  图片、文件等                      │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         第三方服务                        │
│  微信支付、地图服务、短信服务等            │
└─────────────────────────────────────────┘
```

## 技术栈

### 前端
- **框架**: 微信小程序原生框架
- **语言**: TypeScript
- **UI组件**: 自定义组件 + Vant Weapp（可选）

### 后端
- **运行环境**: 微信云开发
- **语言**: TypeScript
- **数据库**: MongoDB（云数据库）
- **存储**: 云存储

### 共享代码
- **类型定义**: TypeScript Interfaces
- **工具函数**: 计价引擎、验证工具等
- **常量配置**: 平台配置、业务规则

## 核心模块

### 1. 用户模块
- 用户注册/登录
- 角色管理（农户、工人、工头、介绍方）
- 实名认证
- 信用体系

### 2. 订单模块
- 需求发布
- 报价管理
- 订单状态流转
- 工作量确认

### 3. 计价模块
- 三种计价模式（记件、按天、包月）
- 自动计算费用
- 加班费计算
- 分账计算

### 4. 支付模块
- 微信支付集成
- 资金分账
- 提现管理
- 对账系统

### 5. 通知模块
- 站内消息
- 微信模板消息
- 推送通知

## 数据流

### 订单创建流程

```
农户发布需求
    │
    ▼
创建订单（pending）
    │
    ▼
工头报价（quoted）
    │
    ▼
农户确认（confirmed）
    │
    ▼
开始工作（in_progress）
    │
    ▼
确认工作量
    │
    ▼
计算费用
    │
    ▼
完成订单（completed）
    │
    ▼
自动分账
```

### 支付流程

```
订单完成
    │
    ▼
计算支付金额
    │
    ▼
调用微信支付
    │
    ▼
支付成功回调
    │
    ▼
自动分账
    ├─→ 工头收入
    ├─→ 平台服务费
    └─→ 介绍方佣金
```

## 安全设计

1. **身份认证**: 微信登录 + JWT Token
2. **权限控制**: 基于角色的访问控制（RBAC）
3. **数据加密**: 敏感信息加密存储
4. **接口安全**: 参数验证、防重放攻击
5. **支付安全**: 签名验证、金额校验

## 性能优化

1. **数据库优化**: 合理使用索引、分页查询
2. **缓存策略**: 热点数据缓存
3. **云函数优化**: 减少冷启动时间
4. **前端优化**: 图片懒加载、代码分包

## 扩展性设计

1. **模块化设计**: 功能模块独立，易于扩展
2. **配置化**: 费率、规则等可配置
3. **插件化**: 支持功能插件扩展
4. **微服务化**: 未来可拆分为微服务架构

